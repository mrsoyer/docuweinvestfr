# üè¢ Automatisation - Flux des Agences et Utilisateurs

## üè¢ Flux Agences

### üéØ Vue d'ensemble
Le syst√®me de synchronisation des agences r√©cup√®re les donn√©es depuis l'API Netty, les enrichit avec des informations Google My Business, et maintient la table `agences` √† jour.

## üì• Workflow 1 - Synchronisation des Agences (n8n)

### ‚ö° Description

{% hint style="info" %}
**URL du workflow** : https://sync.weinvest.app/workflow/hc9I2FGQGRI1xwUX
{% endhint %}

Ce workflow n8n synchronise les donn√©es des agences immobili√®res depuis l'API Netty vers la base de donn√©es.

### üîÑ Fonctionnement d√©taill√©

1. **‚è∞ D√©clenchement programm√©**
   - Ex√©cution planifi√©e r√©guli√®re (Schedule Trigger)

2. **üì° R√©cup√©ration des donn√©es Netty**
   - Appel API : `https://webapi.netty.fr/apiv1/companies`
   - R√©cup√©ration par lots de 10 avec pagination
   - Authentification via header `x-netty-api-key`

3. **üîÑ Traitement des donn√©es**
   - Transformation des r√©seaux sociaux (format `social_networks_[NomReseau]`)
   - Transformation des d√©partements couverts en deux champs :
     - `departments_covered_code` : codes d√©partements
     - `departments_covered_name` : noms d√©partements

4. **üåê Enrichissement Google My Business** (si URL GMB disponible)
   - R√©cup√©ration de l'ID place Google
   - Appel √† l'API SerpAPI pour obtenir :
     - Horaires d'ouverture (lundi √† dimanche)
     - Informations compl√©mentaires
   - Conversion des horaires au format 24h

5. **‚≠ê Calcul de la note moyenne**
   - Requ√™te SQL : `SELECT AVG(rating) FROM reviews WHERE agency_id = {company_id}`
   - Ajout de la note moyenne aux donn√©es de l'agence

6. **üíæ Sauvegarde en base de donn√©es**
   - Upsert dans la table `agences` (INSERT ou UPDATE selon l'existence)
   - Cl√© de matching : `id` (company_id de Netty)

7. **üîî Notification webhook**
   - Appel webhook apr√®s insertion : `https://sync-webhook.weinvest.app/webhook/...`
   - Transmission des IDs pour traitement ult√©rieur

### üìä Champs synchronis√©s

| Champ Netty | Champ DB | Description |
|-------------|----------|-------------|
| company_id | id | Identifiant unique de l'agence |
| name | nom | Nom de l'agence |
| manager_full_name | nom_gerant | Nom du g√©rant |
| address | adresse | Adresse |
| postal_code | code_postal | Code postal |
| city | ville | Ville |
| email | email | Email principal |
| legal_siret_number | siret | Num√©ro SIRET |
| guarantee_fund_amount | montant_fonds_garantie | Montant du fonds de garantie |
| deleted | supprime | Statut de suppression |
| time_modified | date_modification | Date de derni√®re modification |
| social_networks_* | social_networks_* | URLs des r√©seaux sociaux |
| (calcul√©) | note_moyenne | Note moyenne des avis Google |

### üîó APIs et int√©grations

- **API Netty** : Source principale des donn√©es agences
- **Google Maps/SerpAPI** : Enrichissement avec horaires et informations GMB
- **PostgreSQL** : Base de donn√©es de destination
- **Webhook** : Notification pour traitements compl√©mentaires

---

## üë• Flux Utilisateurs

### üéØ Vue d'ensemble
Le syst√®me de synchronisation des utilisateurs (agents immobiliers) r√©cup√®re les donn√©es depuis l'API Netty et maintient la table `users` √† jour.

## üì• Workflow 2 - Synchronisation des Utilisateurs (n8n)

### ‚ö° Description

{% hint style="info" %}
**URL du workflow** : https://sync.weinvest.app/workflow/6U8aAj0SBHnW6IMP
{% endhint %}

Ce workflow n8n synchronise les donn√©es des utilisateurs/agents toutes les 10 minutes.

### üîÑ Fonctionnement d√©taill√©

1. **‚è∞ D√©clenchement programm√©**
   - Ex√©cution toutes les 10 minutes
   - R√©cup√©ration de la derni√®re date de modification en base

2. **üì° R√©cup√©ration des donn√©es Netty**
   - Appel API : `https://webapi.netty.fr/apiv1/users`
   - Tri par date de modification d√©croissante
   - Pagination : 3 pages de 100 utilisateurs (0, 100, 200)
   - Authentification via header `x-netty-api-key`

3. **üîç Filtrage des donn√©es**
   - Filtre sur les utilisateurs ayant une `time_modified`
   - √âvite de traiter les utilisateurs non modifi√©s

4. **üíæ Sauvegarde en base de donn√©es**
   - Upsert dans la table `users`
   - Cl√© de matching : `user_id`
   - Gestion sp√©ciale pour certains IDs (186, 196, 204) : `user_profile = 4`

5. **üñºÔ∏è Gestion du cache d'images**
   - Format avatar : `users-{user_id}.jpg`
   - Purge du cache Imgix apr√®s mise √† jour
   - API Imgix avec Bearer token pour invalidation

### üìä Champs synchronis√©s

| Champ Netty | Champ DB | Description |
|-------------|----------|-------------|
| user_id | user_id | Identifiant unique |
| activated | activated | Statut d'activation |
| first_name | first_name | Pr√©nom |
| last_name | last_name | Nom |
| email | email | Email |
| phone_mobile | phone_mobile | T√©l√©phone mobile |
| job | job | Fonction |
| linked_company_id | linked_company_id | ID de l'agence li√©e |
| legal_status | legal_status | Statut l√©gal |
| departments_covered | departments_covered | D√©partements couverts |
| cities_covered | cities_covered | Villes couvertes |
| presentation_short | presentation_courte | Pr√©sentation courte |
| time_created | time_created | Date de cr√©ation |
| time_modified | time_modified | Date de modification |
| deleted | deleted | Statut de suppression |
| (g√©n√©r√©) | avatar | Nom du fichier avatar |

### üîó APIs et int√©grations

- **API Netty** : Source principale des donn√©es utilisateurs
- **PostgreSQL** : Base de donn√©es de destination
- **Imgix API** : Gestion du cache des avatars

### ‚ö° Optimisations

- **Synchronisation incr√©mentale** : R√©cup√©ration uniquement des modifications r√©centes
- **Traitement par lots** : Pagination pour √©viter les timeouts
- **Cache d'images** : Purge automatique pour forcer le rafra√Æchissement des avatars

### üö® Points d'attention

- Les workflows agences et utilisateurs sont li√©s (linked_company_id)
- La fr√©quence de 10 minutes pour les users assure une synchronisation quasi temps r√©el
- Les IDs sp√©ciaux (186, 196, 204) ont un traitement particulier pour le user_profile
- Le cache Imgix doit √™tre purg√© pour que les nouveaux avatars soient visibles

---

## üîÑ Workflow 3 - Alimentation Bubble et Table Directory (Python)

### üéØ Vue d'ensemble
Ce script Python combine les donn√©es des agences et utilisateurs pour cr√©er un annuaire unifi√©, calcule des statistiques sur les biens, et synchronise le tout avec Bubble et la table `directories`.

### üìù Script de synchronisation

**Fichier** : Script Python de synchronisation des directories

**Utilisation** :
```bash
python sync_directories.py [options]

OPTIONS:
    --test    Utilise l'URL de test de l'API Bubble
```

### üîÑ Fonctionnement d√©taill√©

1. **üîó Fusion des donn√©es agences/utilisateurs**
   - Requ√™te SQL complexe avec UNION ALL
   - Deux branches principales :
     - Agence ID 2 : Users consid√©r√©s comme ind√©pendants
     - Autres agences : Users rattach√©s √† leur agence
   - Exclusion des emails internes Weinvest
   - Exclusion des agences ID 10 et 115

2. **üìä Calcul des statistiques**
   - **Comptage des biens actifs** par agent/agence :
     - Biens en vente (`type_offre = 1`)
     - Biens en location (`type_offre = 2`)
   - **Crit√®res de comptage** :
     - `_id IS NOT NULL` (synchronis√© avec Bubble)
     - `deleted = false`
     - `en_ligne = true`
     - `state = 1 OR state = 6`
   - **Order** : Nombre total de biens + 10000 pour les agences (pour priorisation)

3. **üè∑Ô∏è G√©n√©ration des slugs**
   - Pour les agents (agency_id = 2 ou annuaire = false) :
     - Format : `{nom-agent}-{user_id}`
   - Pour les agences :
     - Format : `{nom-agence}-{agency_id}`
   - Normalisation : suppression accents, espaces remplac√©s par tirets

4. **üîç Gestion des termes de recherche**
   - Cr√©ation d'un array `search` avec : nom, nom_agence, adresse, code_postal, ville
   - V√©rification dans `searchdirectory` Bubble
   - Ajout des nouveaux termes pour l'autocompl√©tion

5. **üîÑ Synchronisation Bubble**
   - **Conditions de synchronisation** : `actif = true`
   - **Cr√©ation** : Si pas d'ID Bubble existant
   - **Mise √† jour** : Si ID Bubble existant
   - **Suppression** : Si `actif = false` et ID Bubble existant

6. **üíæ Sauvegarde PostgreSQL**
   - Table cible : `directories` (ou `directories_staging` en test)
   - Upsert bas√© sur `temp_slug`
   - Stockage de l'ID Bubble (`_id`)

### üìä Structure des donn√©es

| Champ | Description | Source |
|-------|-------------|--------|
| id | ID unique (user_id ou agency_id) | Calcul√© |
| annuaire | Flag pour diff√©rencier agents/agences | Calcul√© |
| nom | Nom affich√© | User ou agence |
| nom_agence | Nom de l'agence | Table agences |
| adresse | Adresse (vide pour agents sauf ind√©pendants) | Conditionnel |
| telephone | T√©l√©phone principal | Mobile, fixe ou secondaire |
| presentation | Pr√©sentation courte | User ou agence |
| actif | Statut d'activation | activated ou !supprime |
| image | URL de l'image principale | Netty ou agence |
| mignature | URL de la miniature | Priorit√© : mignature > image |
| google_my_business | URL GMB | Table agences |
| monday-sunday | Horaires d'ouverture | Table agences |
| note_moyenne | Note moyenne Google | Table agences |
| order | Ordre d'affichage | Nombre de biens (+10000 pour agences) |
| vente | Nombre de biens en vente | Calcul√© |
| loc | Nombre de biens en location | Calcul√© |
| temp_slug | Identifiant unique pour l'URL | G√©n√©r√© |
| search | Termes de recherche | Array g√©n√©r√© |
| _id | ID Bubble | Stock√© apr√®s sync |

### üîß Configuration requise

- **Variables d'environnement** :
  - `DB_URL` : URL de connexion PostgreSQL
  - `BUBBLE_API_KEY` : Cl√© API Bubble
  - `BUBBLE_API_URL` : URL de l'API Bubble

### ‚ö° Optimisations

1. **Traitement par lots** : BATCH_SIZE = 10
2. **Validation des donn√©es** : V√©rification des champs requis avant traitement
3. **Gestion des erreurs** : Continue m√™me si certains enregistrements √©chouent
4. **Cache de recherche** : √âvite les doublons dans searchdirectory

### üö® Points d'attention

- Les emails internes Weinvest sont exclus de la synchronisation
- Les agences 10 et 115 sont exclues
- L'ordre d'affichage favorise les agences (+10000) par rapport aux agents individuels
- Le champ `search` n√©cessite un format array PostgreSQL sp√©cial
- Le mot r√©serv√© SQL `order` est g√©r√© avec des guillemets
- SSL warnings d√©sactiv√©s pour les appels API

### ‚ö†Ô∏è Probl√®me critique - Gestion des suppressions

{% hint style="danger" %}
**Absence de gestion automatique des suppressions**

**Probl√®me actuel** :
- Les donn√©es de suppression ne sont pas disponibles depuis l'API Netty
- Aucun gestionnaire de suppression n'a √©t√© impl√©ment√©
- Les utilisateurs et agences supprim√©s restent dans le syst√®me

**Solution temporaire** :
- Suppression manuelle en cachant les enregistrements directement dans Bubble
- Processus non scalable et source d'erreurs

**Action requise** :
Construire une solution propre pour g√©rer les suppressions, par exemple :
- Webhook de notification depuis Netty lors des suppressions
- Interface d'administration pour marquer les suppressions
- Script de comparaison p√©riodique pour d√©tecter les √©l√©ments supprim√©s
- Soft delete avec champ `deleted_at` et processus de nettoyage
{% endhint %}

### üìà Flux de donn√©es complet

```mermaid
graph TD
    A[Tables agences + users] -->|Requ√™te SQL complexe| B[Donn√©es fusionn√©es]
    B -->|Calcul statistiques| C[Comptage biens]
    C -->|G√©n√©ration slugs| D[Identifiants uniques]
    D -->|Si actif=true| E[Sync Bubble Directory]
    D -->|Toujours| F[Table directories]
    D -->|Termes recherche| G[Bubble searchdirectory]
    E -->|ID Bubble| F
```

### üîÑ Interaction avec les autres flux

Ce script Python d√©pend directement des donn√©es synchronis√©es par :
- **Workflow Agences n8n** : Pour les donn√©es des agences
- **Workflow Users n8n** : Pour les donn√©es des agents
- **Workflow Biens** : Pour le comptage des propri√©t√©s actives

Il cr√©e un annuaire unifi√© qui combine toutes ces sources pour l'affichage sur le site web. 